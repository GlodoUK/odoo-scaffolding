{% import "_macros.jinja" as macros -%}
version: "2.4"

services:
  odoo:
    {%- if odoo_oci_image %}
    image: {{ odoo_oci_image }}:{{ macros.version_minor(odoo_version) }}
    {%- endif %}
    build:
      context: ./odoo
      args:
        {%- if odoo_version >= 11 %}
        DB_VERSION: "{{ postgres_version or 'latest' }}"
        {%- endif %}
        ODOO_VERSION: "{{ macros.version_minor(odoo_version) }}"
        UID: "${UID:-1000}"
        GID: "${GID:-1000}"
    environment:
      PGDATABASE: &dbname {{ postgres_dbname }}
      PGUSER: &dbuser "{{ postgres_username }}"
      DB_FILTER: "{{ odoo_dbfilter }}"
      PROXY_MODE: "{% if odoo_proxy %}true{% else %}false{% endif %}"
      LIST_DB: "{{ odoo_listdb | tojson }}"
    tty: true
    volumes:
      - filestore:/var/lib/odoo:z

  {% if postgres_version -%}
  db:
    image: ghcr.io/tecnativa/postgres-autoconf:{{ postgres_version }}-alpine
    shm_size: 2gb
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: *dbuser
      # Why locale C? PostgreSQL is "under-optimized" with the use of 
      # LIKE queries using wildcards (LIKE 'foo%') in conjunction with btree
      # indexes, when not using locale C.
      # See:
      #   - https://github.com/odoo/odoo/pull/25196#issuecomment-396683972
      #   - https://www.postgresql.org/docs/16/indexes-types.html#INDEXES-TYPES-BTREE
      POSTGRES_INITDB_ARGS: "--locale=C --encoding=UTF8"
      CONF_EXTRA: |
        work_mem = 512MB
    volumes:
      - db:/var/lib/postgresql/data:z
  {%- endif %}

  smtpfake:
    image: axllent/mailpit
